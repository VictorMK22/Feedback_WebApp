{% extends 'base.html' %}
{% load static i18n %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
          <i class="far fa-edit me-2 text-primary"></i>
          {% trans "Edit Feedback" %}
        </h2>
        <a href="{% url 'feedback:feedback-detail' feedback.pk %}" class="btn btn-outline-secondary">
          <i class="fas fa-times me-1"></i>
          {% trans "Cancel" %}
        </a>
      </div>

      <div class="card shadow-sm">
        <div class="card-body p-4">
          <form method="post" enctype="multipart/form-data" id="feedbackForm">
            {% csrf_token %}
            
            <!-- Category -->
            <div class="mb-4">
              <label for="{{ form.category.id_for_label }}" class="form-label fw-bold">
                {% trans "Category" %} <span class="text-danger">*</span>
              </label>
              {{ form.category }}
              {% if form.category.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.category.errors }}
                </div>
              {% endif %}
            </div>

            <!-- Rating -->
            <div class="mb-4">
              <label class="form-label fw-bold">
                {% trans "Rating" %} <span class="text-danger">*</span>
              </label>
              <div class="rating-input">
                <input type="hidden" name="rating" id="rating" value="{{ feedback.rating }}" required>
                <div class="star-rating">
                  {% for i in "12345" %}
                  <i class="far fa-star star" data-rating="{{ forloop.counter }}" 
                     {% if forloop.counter <= feedback.rating %}style="color: #ffc107;"{% endif %}></i>
                  {% endfor %}
                </div>
                <small class="text-muted d-block mt-2">
                  {% trans "Current rating:" %} <span id="current-rating">{{ feedback.rating }}</span>/5
                </small>
              </div>
            </div>

            <!-- Content -->
            <div class="mb-4">
              <label for="{{ form.content.id_for_label }}" class="form-label fw-bold">
                {% trans "Feedback Content" %} <span class="text-danger">*</span>
              </label>
              {{ form.content }}
              {% if form.content.errors %}
                <div class="invalid-feedback d-block">
                  {{ form.content.errors }}
                </div>
              {% endif %}
              <small class="text-muted">
                {% trans "Please provide detailed feedback to help us improve our services." %}
              </small>
            </div>

            <!-- Existing Attachments -->
            {% if feedback.attachments.all %}
            <div class="mb-4">
            <label class="form-label fw-bold">
                {% trans "Current Attachments" %}
            </label>
            <div class="existing-attachments">
                {% for attachment in feedback.attachments.all %}
                <div class="alert alert-info d-flex justify-content-between align-items-center">
                <div>
                    {% if ".pdf" in attachment.file.name %}
                    <i class="fas fa-file-pdf text-danger me-2"></i>
                    {% else %}
                    <i class="fas fa-file-image text-primary me-2"></i>
                    {% endif %}
                    <span>{{ attachment.file.name|slice:"-30:" }}</span>
                </div>
                <a href="{{ attachment.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye me-1"></i>
                    {% trans "View" %}
                </a>
                </div>
                {% endfor %}
            </div>
            <small class="text-muted">
                {% trans "Note: Adding new attachments will keep existing ones." %}
            </small>
            </div>
            {% endif %}

            <!-- New Attachments -->
            <div class="mb-4">
              <label for="attachments" class="form-label fw-bold">
                {% trans "Add New Attachments" %}
              </label>
              <input type="file" 
                     class="form-control" 
                     id="attachments" 
                     name="attachments" 
                     multiple
                     accept=".pdf,.jpg,.jpeg,.png">
              <small class="text-muted d-block mt-2">
                {% trans "Accepted formats: PDF, JPG, JPEG, PNG (Max 5MB each)" %}
              </small>
              <div id="file-preview" class="mt-3"></div>
            </div>

            <!-- Submit Buttons -->
            <div class="d-flex justify-content-end gap-2">
              <a href="{% url 'feedback:feedback-detail' feedback.pk %}" class="btn btn-outline-secondary">
                <i class="fas fa-times me-1"></i>
                {% trans "Cancel" %}
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>
                {% trans "Update Feedback" %}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .star-rating {
    font-size: 2rem;
    cursor: pointer;
  }
  
  .star-rating .star {
    transition: color 0.2s ease;
  }
  
  .star-rating .star:hover,
  .star-rating .star.hover {
    color: #ffc107 !important;
  }
  
  textarea {
    min-height: 150px;
  }
  
  .file-preview-item {
    display: flex;
    align-items: center;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 0.25rem;
    margin-bottom: 0.5rem;
  }
  
  .file-preview-item i {
    font-size: 1.5rem;
    margin-right: 0.75rem;
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Star rating functionality
    const stars = document.querySelectorAll('.star');
    const ratingInput = document.getElementById('rating');
    const currentRatingSpan = document.getElementById('current-rating');
    
    stars.forEach(star => {
      star.addEventListener('click', function() {
        const rating = this.getAttribute('data-rating');
        ratingInput.value = rating;
        currentRatingSpan.textContent = rating;
        updateStars(rating);
      });
      
      star.addEventListener('mouseenter', function() {
        const rating = this.getAttribute('data-rating');
        highlightStars(rating);
      });
    });
    
    document.querySelector('.star-rating').addEventListener('mouseleave', function() {
      const currentRating = ratingInput.value;
      updateStars(currentRating);
    });
    
    function updateStars(rating) {
      stars.forEach((star, index) => {
        if (index < rating) {
          star.classList.remove('far');
          star.classList.add('fas');
          star.style.color = '#ffc107';
        } else {
          star.classList.remove('fas');
          star.classList.add('far');
          star.style.color = '';
        }
      });
    }
    
    function highlightStars(rating) {
      stars.forEach((star, index) => {
        if (index < rating) {
          star.style.color = '#ffc107';
        } else {
          star.style.color = '';
        }
      });
    }
    
    // File preview
    const fileInput = document.getElementById('attachments');
    const filePreview = document.getElementById('file-preview');
    
    fileInput.addEventListener('change', function() {
      filePreview.innerHTML = '';
      const files = this.files;
      
      if (files.length > 0) {
        Array.from(files).forEach(file => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-preview-item';
          
          let icon = 'fa-file';
          if (file.type.includes('pdf')) icon = 'fa-file-pdf text-danger';
          else if (file.type.includes('image')) icon = 'fa-file-image text-primary';
          
          fileItem.innerHTML = `
            <i class="fas ${icon}"></i>
            <div>
              <div>${file.name}</div>
              <small class="text-muted">${(file.size / 1024).toFixed(2)} KB</small>
            </div>
          `;
          
          filePreview.appendChild(fileItem);
        });
      }
    });
  });
</script>
{% endblock %}