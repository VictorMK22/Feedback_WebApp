{% extends "base.html" %}
{% load i18n humanize %}

{% block content %}
<div class="container py-4" data-notification-id="{{ notification.id }}" data-unread="{% if notification.status == 'Unread' %}true{% else %}false{% endif %}">
  <div class="card shadow-sm">

    <!-- Header -->
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-bell me-2 text-primary"></i>
        {% trans "Notification" %}
      </h5>
      <small class="text-muted">
        {{ notification.timestamp|naturaltime }}
      </small>
    </div>

    <!-- Body -->
    <div class="card-body">

      <!-- Message -->
      <div class="mb-4">
        <p class="fs-6 mb-0">{{ notification.message }}</p>
      </div>

      <!-- Metadata -->
      {% if notification.meta_data %}
      <div class="mb-4">
        <h6 class="text-muted">{% trans "Additional Information" %}</h6>
        <ul class="list-group list-group-flush">
          {% for key, value in notification.meta_data.items %}
          <li class="list-group-item px-0">
            <strong>{{ key|capfirst }}:</strong> {{ value }}
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      <!-- Related Feedback -->
      {% if notification.feedback %}
      <div class="mb-4">
        <h6 class="text-muted">{% trans "Related Feedback" %}</h6>
        <div class="border rounded p-3 bg-light">
          <p class="mb-2">
            {{ notification.feedback.content|truncatechars:200 }}
          </p>
          <a href="{% url 'feedback:feedback-detail' notification.feedback.id %}"
             class="btn btn-sm btn-outline-primary">
            <i class="fas fa-external-link-alt me-1"></i>
            {% trans "View Feedback" %}
          </a>
        </div>
      </div>
      {% endif %}

      <!-- External Link -->
      {% if notification.link %}
      <div class="mb-4">
        <a href="{{ notification.link }}"
           class="btn btn-outline-secondary"
           target="_blank">
          <i class="fas fa-link me-1"></i>
          {% trans "Open related link" %}
        </a>
      </div>
      {% endif %}

    </div>

    <!-- Footer -->
    <div class="card-footer bg-white d-flex justify-content-between">
      <a href="{% url 'feedback:notification-list' %}"
         class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>
        {% trans "Back to notifications" %}
      </a>

      {% trans "Are you sure you want to delete this notification?" as delete_confirm %}

      <!-- Delete Button -->
      <form action="{% url 'feedback:delete-notification' notification.id %}" method="post" class="d-inline">
      {% csrf_token %}
      <button type="submit" class="btn btn-sm btn-outline-danger"
            onclick="return confirm('{{ delete_confirm|escapejs }}');">
        <i class="fas fa-trash me-1"></i>
        {% trans "Delete" %}
      </button>
      </form>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {

  const container = document.querySelector('[data-notification-id]');
  if (!container) return;

  const isUnread = container.dataset.unread === 'True';
  const notificationId = container.dataset.notificationId;

  if (!isUnread) return;

  fetch(`/notifications/${notificationId}/mark-read/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
      'X-Requested-With': 'XMLHttpRequest'
    },
    credentials: 'same-origin'
  })
  .catch(error => {
    console.error('Auto mark-as-read failed:', error);
  });

});
</script>
{% endblock %}
