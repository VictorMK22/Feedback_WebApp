{% extends "base.html" %}
{% load static i18n humanize %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">{% trans "Generated Reports" %}</h2>
        <div>
            <a href="{% url 'reports:create' %}" class="btn btn-primary">
                <i class="fas fa-plus-circle me-1"></i> {% trans "New Report" %}
            </a>
            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#exportModal">
                <i class="fas fa-download me-1"></i> {% trans "Export" %}
            </button>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    {% endif %}

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>{% trans "Type" %}</th>
                            <th>{% trans "Generated" %}</th>
                            <th class="text-center">{% trans "Resolved" %}</th>
                            <th class="text-center">{% trans "Pending" %}</th>
                            <th class="text-center">{% trans "Satisfaction" %}</th>
                            <th class="text-center">{% trans "Status" %}</th>
                            <th class="text-end">{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in reports %}
                        <tr class="{% if report.is_latest %}table-success{% endif %}">
                            <td>
                                <strong>{{ report.get_report_type_display }}</strong>
                                {% if report.is_latest %}
                                <span class="badge bg-info ms-2">{% trans "Latest" %}</span>
                                {% endif %}
                            </td>
                            <td>
                                <span data-bs-toggle="tooltip" title="{{ report.generated_at|date:'DATETIME_FORMAT' }}">
                                    {{ report.generated_at|naturaltime }}
                                </span>
                            </td>
                            <td class="text-center">{{ report.resolved_feedback_count|intcomma }}</td>
                            <td class="text-center">{{ report.pending_feedback_count|intcomma }}</td>
                            <td class="text-center">
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-{% if report.satisfaction_level == 'high' %}success{% elif report.satisfaction_level == 'medium' %}warning{% else %}danger{% endif %}" 
                                         role="progressbar" 
                                         style="width: {{ report.satisfaction_percentage }}%" 
                                         aria-valuenow="{{ report.satisfaction_percentage }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        {{ report.overall_satisfaction_score|floatformat:1 }}
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-{% if report.status == 'published' %}success{% else %}secondary{% endif %}">
                                    {{ report.get_status_display }}
                                </span>
                            </td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{% url 'reports:detail' report.id %}" class="btn btn-outline-primary" data-bs-toggle="tooltip" title="{% trans 'View details' %}">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'reports:download' report.id %}" class="btn btn-outline-success" data-bs-toggle="tooltip" title="{% trans 'Download PDF' %}">
                                        <i class="fas fa-file-pdf"></i>
                                    </a>
                                    <a href="{% url 'reports:edit' report.id %}" class="btn btn-outline-secondary" data-bs-toggle="tooltip" title="{% trans 'Edit' %}">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-file-alt fa-3x mb-3"></i>
                                    <h5>{% trans "No reports generated yet" %}</h5>
                                    <p class="mb-0">{% trans "Create your first report to get started" %}</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% if is_paginated %}
    <nav aria-label="Report pagination" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1" aria-label="First">
                    <span aria-hidden="true">&laquo;&laquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Last">
                    <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">{% trans "Export Reports" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="get" action="{% url 'reports:export' %}">
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label">{% trans "Format" %}</label>
                        <select class="form-select" id="exportFormat" name="format">
                            <option value="csv">CSV</option>
                            <option value="xlsx">Excel</option>
                            <option value="pdf">PDF</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="dateRange" class="form-label">{% trans "Date Range" %}</label>
                        <input type="text" class="form-control date-range-picker" id="dateRange" name="date_range">
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-download me-1"></i> {% trans "Export" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Initialize date range picker
    $('.date-range-picker').daterangepicker({
        opens: 'right',
        locale: {
            format: 'YYYY-MM-DD',
            applyLabel: '{% trans "Apply" %}',
            cancelLabel: '{% trans "Cancel" %}',
            fromLabel: '{% trans "From" %}',
            toLabel: '{% trans "To" %}',
            customRangeLabel: '{% trans "Custom" %}',
            daysOfWeek: [
                '{% trans "Su" %}', 
                '{% trans "Mo" %}', 
                '{% trans "Tu" %}', 
                '{% trans "We" %}', 
                '{% trans "Th" %}', 
                '{% trans "Fr" %}', 
                '{% trans "Sa" %}'
            ],
            monthNames: [
                '{% trans "January" %}', 
                '{% trans "February" %}', 
                '{% trans "March" %}', 
                '{% trans "April" %}', 
                '{% trans "May" %}', 
                '{% trans "June" %}', 
                '{% trans "July" %}', 
                '{% trans "August" %}', 
                '{% trans "September" %}', 
                '{% trans "October" %}', 
                '{% trans "November" %}', 
                '{% trans "December" %}'
            ],
            firstDay: 1
        }
    });
});
</script>
{% endblock %}